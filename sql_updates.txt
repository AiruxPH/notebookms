-- Run these commands in your Database SQL Tab (phpMyAdmin or similar)

-- 1. Add 'is_pinned' column to 'notes' table
ALTER TABLE `notes` ADD COLUMN `is_pinned` TINYINT(1) DEFAULT 0;

-- 2. Add 'is_archived' column to 'notes' table
ALTER TABLE `notes` ADD COLUMN `is_archived` TINYINT(1) DEFAULT 0;

-- Update: Create Categories Table
CREATE TABLE IF NOT EXISTS categories (
  id int(11) NOT NULL AUTO_INCREMENT,
  user_id int(11) DEFAULT 0,
  name varchar(100) NOT NULL,
  color varchar(50) DEFAULT '#ffffff',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Seed Default Categories
INSERT INTO categories (user_id, name, color) VALUES
(0, 'General', '#fff9c4'), -- Yellow
(0, 'Personal', '#e8f5e9'), -- Green
(0, 'Work', '#e3f2fd'), -- Blue
(0, 'Study', '#fce4ec'), -- Pink
(0, 'Ideas', '#f3e5f5'); -- Purple

-- Update: Create Users Table (if not exists)
CREATE TABLE IF NOT EXISTS users (
  id int(11) NOT NULL AUTO_INCREMENT,
  username varchar(255) NOT NULL,
  password varchar(255) NOT NULL,
  is_guest tinyint(1) DEFAULT 0,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- 3. Create Trigger to Limit Categories per User (Max 20)
DELIMITER //
CREATE TRIGGER limit_category_count
BEFORE INSERT ON categories
FOR EACH ROW
BEGIN
    DECLARE cat_count INT;
    SELECT COUNT(*) INTO cat_count FROM categories WHERE user_id = NEW.user_id;
    IF cat_count >= 20 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Limit reached: Maximum 20 categories per user allowed.';
    END IF;
END;
//
DELIMITER ;


-- 4. Database Normalization: Replace category string with category_id
-- Step A: Add the new column
ALTER TABLE `notes` ADD COLUMN `category_id` INT(11) DEFAULT NULL;

-- Step B: Migrate Data (Match existing names to IDs)
UPDATE `notes` n 
SET n.category_id = (
    SELECT c.id FROM `categories` c 
    WHERE c.name = n.category 
    AND (c.user_id = n.user_id OR c.user_id = 0) 
    ORDER BY c.user_id DESC
    LIMIT 1
);

-- Step C: Handle Unmatched (Set to General ID 1 if null)
UPDATE `notes` SET category_id = 1 WHERE category_id IS NULL;

-- Step D: Add Foreign Key Constraint
ALTER TABLE `notes` ADD CONSTRAINT `fk_note_category` 
FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL;

-- Step E: Drop the old string column
ALTER TABLE `notes` DROP COLUMN `category`;


-- 5. Add 'security_word' and 'security_word_set' columns to 'users' table
-- (Required for Forgot Password feature)
ALTER TABLE users ADD COLUMN security_word VARCHAR(255) DEFAULT NULL AFTER date_modified;
ALTER TABLE users ADD COLUMN security_word_set TINYINT(1) NOT NULL DEFAULT 0 AFTER security_word;
